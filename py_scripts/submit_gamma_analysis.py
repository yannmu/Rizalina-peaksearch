import os
import sys
import time
from argparse import ArgumentParser
from time import sleep
import numpy as np
from random import randint
import os.path


parser = ArgumentParser()
requiredNamed = parser.add_argument_group("required named arguments")

#ToDO: add few more parameters to use for the shell script selection
parser.add_argument ("-s", help="scripts to run", dest = "script",  default="")
parser.add_argument ("-d", help="dir of shell scripts", dest = "scripts_dir",  default="../shell_scripts/")
args = parser.parse_args()
global script
script = args.script
script_dir = args.scripts_dir

bat_precision = "low"
datasets=["EnrBEGe", "EnrCoax"]


def create_job_name(script):
	if script =="":
		script = sys.argv[0]
		script = script.replace('submit', 'run')
		script = script.replace('.py', '.sh')
		script = "".join([script_dir, script])
		idx2 = script.index('.sh')
		idx1 = script.index('run_')
	return script, script[idx1+len('run_'): idx2]

print("settings")
ibinning = 1
woi = 12
pseudo_path="/nfs/gerda2/users/rizalinko/gerda-bkg-model/gerda-bkg-model/input/data/"
scr, job = create_job_name(script)

submitted_j = 0
analysed_pseudo = [0, 1, 90113, 90114, 163840, 163841, 180233, 213003, 163851, 163853, 213005, 40978, 213018, 213024, 213040, 213043, 213044, 213047, 213049, 213050, 180284, 213054, 213055, 213057, 41026, 213058, 163910, 213062, 180296, 213065, 213068, 213069, 163918, 213070, 213071, 213073, 90189, 163921, 213076, 213080, 180312, 163933, 213086, 213085, 180320, 213089, 213091, 90214, 213095, 213096, 213099, 163949, 213102, 213103, 90224, 90225, 180338, 213108, 41077, 90229, 213111, 213112, 41081, 213113, 163964, 213120, 213121, 163978, 163979, 180364, 90256, 163987, 180379, 90269, 213150, 90274, 213157, 213158, 213159, 90281, 213161, 90284, 90287, 164016, 41135, 41138, 90290, 213167, 213171, 213174, 41143, 41144, 164020, 213178, 41149, 41150, 213185, 213189, 164038, 41160, 213198, 41169, 213202, 180436, 213205, 213206, 213207, 213208, 164053, 213210, 90331, 213214, 213221, 90345, 41194, 180458, 41197, 41199, 41200, 41203, 180468, 213237, 180470, 213239, 41208, 164090, 180475, 41211, 213246, 164095, 90368, 41217, 213247, 180483, 41220, 180484, 180488, 41225, 90378, 90377, 164105, 164107, 90382, 90384, 90385, 213270, 164121, 213274, 180509, 180510, 164127, 213280, 164128, 41250, 164130, 213283, 213285, 180520, 213289, 90412, 164141, 90414, 213299, 41271, 90426, 41277, 213309, 90429, 180549, 164165, 213319, 41289, 41291, 180560, 180563, 90452, 213332, 213336, 213337, 90459, 41308, 41309, 41310, 213342, 41314, 90468, 213350, 164200, 164206, 213358, 90480, 213363, 41333, 41336, 213368, 213373, 41343, 41345, 41347, 213382, 90506, 213389, 41358, 41360, 41361, 164243, 213395, 90517, 41367, 41368, 41370, 164251, 164255, 90533, 41384, 164265, 90539, 90541, 180660, 164278, 41401, 90553, 41404, 41405, 90556, 41407, 90561, 164295, 41416, 164311, 180695, 164319, 164320, 90598, 90604, 180720, 180722, 180736, 180737, 180743, 164365, 90659, 164387, 164389, 164390, 180774, 164391, 164393, 164394, 164392, 164398, 164401, 164402, 164404, 164408, 164409, 90682, 164411, 164420, 164423, 164424, 90702, 90721, 90753, 90761, 164490, 164492, 164493, 164494, 41626, 90805, 90811, 90821, 90827, 90830, 41689, 140029, 140091, 41795, 140103, 90970, 50011, 50012, 50013, 50015, 140135, 50023, 50025, 50031, 50032, 50033, 50034, 50035, 50036, 91001, 41880, 91035, 91043, 50085, 41894, 140201, 50093, 50098, 140242, 91093, 50141, 91104, 140264, 91122, 41979, 140286, 91142, 50183, 91156, 91169, 91170, 91171, 140325, 140337, 91188, 91189, 91192, 91195, 91196, 91198, 140352, 50243, 91212, 140371, 42070, 91223, 91228, 42088, 42089, 42094, 91270, 50316, 50322, 50326, 42134, 140446, 91295, 140451, 50344, 91306, 140459, 91311, 91317, 140470, 91319, 91320, 140473, 91327, 91328, 91329, 91334, 50378, 50379, 50380, 140493, 91342, 50384, 91344, 50386, 50389, 50390, 50391, 50393, 91355, 50397, 50400, 91361, 50410, 91373, 50424, 91392, 50433, 140544, 50436, 50437, 50445, 140564, 50473, 140585, 140594, 50499, 50501, 50520, 140633, 50527, 50530, 140645, 50540, 50563, 50597, 50611, 50632, 50654, 50666, 140778, 140781, 50679, 50691, 50767, 50783, 1631, 50803, 1664, 100002, 50852, 100008, 100010, 100019, 100030, 100031, 100032, 100033, 100034, 190153, 190154, 190155, 190156, 50905, 100059, 50920, 100077, 100083, 100098, 100104, 10000, 10001, 50983, 51018, 51019, 100200, 51056, 51067, 100226, 100230, 51081, 100248, 100271, 51127, 51128, 51133, 51135, 100300, 51149, 51150, 51154, 51160, 100318, 100328, 51178, 51183, 100337, 100342, 51193, 51197, 100352, 100359, 100365, 100366, 51216, 190482, 51220, 100382, 51240, 51241, 100403, 100407, 51268, 100427, 100430, 51282, 100436, 100439, 100444, 2152, 100460, 100464, 51316, 100476, 51334, 51341, 51342, 51345, 100507, 100512, 51364, 51365, 100516, 51367, 100532, 51381, 100533, 51391, 100545, 51396, 100551, 100557, 100558, 10456, 51416, 51418, 100578, 51442, 100611, 100620, 190831, 100728, 100776, 100783, 100852, 100855, 150010, 150015, 150019, 100871, 51733, 100960, 150113, 150118, 60010, 60015, 51824, 60029, 51843, 60035, 60045, 150165, 150166, 150167, 150168, 101019, 51871, 191136, 150178, 101039, 60087, 150204, 60098, 101065, 60125, 60126, 60130, 150246, 51945, 60139, 101114, 101115, 101117, 60164, 101125, 101124, 60168, 101128, 101130, 101132, 101134, 101135, 101143, 101145, 101148, 101151, 191274, 101178, 101184, 101202, 60247, 101210, 101214, 60256, 101217, 101219, 191333, 150378, 101227, 191342, 101236, 150389, 150393, 60284, 101249, 150407, 101257, 101259, 101273, 150428, 60320, 150433, 101282, 101285, 101287, 101289, 60330, 150450, 101299, 60341, 60347, 60350, 52162, 60359, 101319, 191434, 60367, 101327, 101334, 60377, 60384, 150501, 150502, 191463, 101356, 60399, 60403, 60404, 60405, 101363, 60408, 150520, 101374, 150531, 101383, 101387, 101388, 191499, 101400, 101405, 150561, 60479, 60481, 60486, 150607, 11344, 60499, 60500, 150614, 150615, 150624, 60514, 60565, 60569, 60588, 191675, 60604, 150746, 60650, 150776, 60675, 60686, 60692, 60704, 200006, 60743, 200015, 200016, 200017, 200018, 60761, 200027, 200028, 60767, 200032, 200033, 200036, 200039, 200052, 200073, 60809, 11661, 60815, 60835, 110007, 110008, 110019, 60868, 60877, 110045, 200160, 60903, 191975, 200172, 200173, 200174, 200175, 60908, 60922, 110079, 60941, 200212, 20000, 20001, 60967, 110135, 110143, 60996, 200261, 60999, 20046, 61007, 192135, 61074, 110228, 11929, 3761, 3763, 3764, 3768, 110271, 3777, 200391, 110281, 3787, 200398, 3790, 200402, 61144, 61146, 61150, 192227, 200423, 3816, 3817, 61163, 110317, 3821, 3823, 61168, 110321, 61170, 12016, 110324, 61176, 200441, 3836, 3837, 3838, 200446, 3840, 61185, 110337, 3841, 61188, 3843, 3845, 3846, 3847, 110345, 3848, 3849, 3852, 3853, 61198, 3850, 3851, 20241, 61202, 3859, 3861, 3863, 61207, 3865, 3866, 200475, 110364, 110365, 3870, 3871, 3872, 3873, 3874, 61217, 3876, 3877, 200487, 61224, 12075, 3883, 3884, 3886, 3889, 61233, 61235, 3892, 61238, 110391, 3899, 61245, 3902, 200510, 3901, 3906, 3908, 61253, 12105, 3915, 3916, 12107, 3918, 3917, 61265, 192339, 61267, 3925, 3928, 200538, 3933, 3934, 12131, 200547, 110438, 61287, 200554, 61293, 12143, 61307, 61309, 61312, 3968, 110466, 110467, 200580, 61324, 200588, 3985, 200595, 3988, 61335, 3998, 110494, 200607, 110498, 61350, 4010, 4011, 4012, 4013, 4014, 4015, 4016, 4017, 4018, 4019, 4020, 4021, 4022, 4023, 4024, 4025, 4026, 4027, 4028, 4029, 4030, 4031, 4032, 4033, 4034, 110526, 4036, 4037, 4038, 4039, 4040, 4041, 4042, 4043, 4044, 4045, 4046, 4047, 4049, 4050, 4051, 4053, 4054, 4055, 4056, 4057, 4058, 61403, 4059, 4061, 4064, 4065, 4066, 20450, 4070, 4072, 4074, 4075, 4076, 61421, 4080, 4082, 4083, 4084, 4085, 110583, 4088, 4089, 4091, 200700, 4092, 4093, 4096, 192513, 4098, 4100, 4106, 4111, 4112, 4113, 4115, 4118, 4119, 4122, 4125, 4126, 4127, 4128, 4129, 4130, 4131, 4132, 4136, 4137, 4138, 4139, 4140, 200748, 12334, 4143, 4142, 4145, 4141, 4147, 4144, 4146, 4150, 4151, 4148, 4153, 4154, 4155, 4156, 4157, 200765, 4159, 4160, 4152, 4162, 4163, 4164, 4161, 110662, 4168, 4169, 4170, 4172, 4173, 4174, 200782, 4176, 4177, 4179, 4184, 4185, 4186, 110683, 4188, 4189, 4190, 4193, 4196, 4197, 4198, 4202, 4204, 110701, 4210, 4212, 4220, 4239, 4245, 4257, 4268, 4277, 110775, 4290, 4303, 4304, 4305, 4306, 4307, 4308, 4309, 4311, 4312, 4313, 4314, 4315, 4316, 4320, 4321, 4322, 160003, 160004, 160023, 160036, 160045, 4149, 160167, 160168, 160169, 160170, 160220, 160250, 160255, 160283, 160288, 160312, 160366, 160367, 160371, 160374, 160386, 61189, 160411, 160424, 160428, 160436, 160438, 160440, 160458, 160464, 160477, 160484, 160509, 160534, 160541, 160542, 160547, 160577, 160586, 160631, 160640, 160646, 160649, 160742, 163835, 160766, 21540, 21548, 21552, 21560, 210009, 210010, 210015, 210020, 210024, 210041, 210042, 210120, 120010, 120012, 120014, 210145, 210157, 210159, 210160, 120073, 210200, 13595, 120108, 30000, 30001, 210230, 210231, 30008, 30011, 30014, 30016, 120131, 210250, 30027, 30033, 30035, 210271, 30048, 210277, 210284, 30061, 161132, 210287, 120182, 30093, 120228, 30117, 210351, 210358, 21945, 30152, 30160, 120281, 210399, 120290, 61358, 180219, 61359, 21995, 210417, 210418, 30196, 161273, 210425, 161282, 210450, 210454, 210465, 30252, 22080, 120386, 120389, 30279, 210507, 30288, 210515, 161367, 30295, 210521, 22110, 30320, 210548, 30328, 120442, 210560, 30339, 210568, 210569, 161437, 120484, 30376, 30381, 30385, 30392, 210631, 30409, 30411, 30412, 120528, 161491, 210660, 161513, 30444, 210676, 30464, 120585, 210698, 161554, 120600, 120610, 30502, 210737, 30517, 210762, 210766, 30557, 30562, 30570, 30572, 30603, 30606, 120720, 30617, 161690, 120750, 30648, 30651, 120764, 161730, 161731, 161732, 30658, 120777, 120779, 161740, 161764, 30699, 212889, 212890, 30727, 30738, 212895, 210979, 30761, 30762, 211030, 30829, 80011, 80012, 30859, 30863, 80020, 211094, 80023, 80024, 80025, 80029, 80031, 80033, 80038, 80057, 80060, 80097, 211188, 30987, 211223, 211237, 80172, 80185, 31033, 80187, 80216, 31086, 31087, 80241, 80242, 31096, 31115, 80268, 80279, 80284, 31141, 31144, 31146, 31150, 31154, 31161, 80313, 31167, 80319, 31169, 80323, 31180, 31183, 31197, 31198, 80350, 80352, 31203, 80357, 80359, 31209, 211439, 80369, 31219, 80385, 31239, 31247, 80400, 80401, 31250, 31264, 80432, 31287, 31288, 31289, 31294, 31297, 31299, 31311, 31313, 31315, 80469, 80470, 31319, 31330, 31331, 31332, 80489, 31339, 31345, 31365, 31367, 211596, 80525, 80527, 31380, 80545, 31400, 80562, 80563, 80579, 31442, 80594, 80625, 80629, 80638, 211731, 80685, 80690, 211783, 80721, 31614, 80796, 80806, 80853, 110508, 80862, 130045, 130046, 80893, 80901, 80902, 31807, 40000, 40007, 130123, 40013, 40015, 40017, 40018, 40020, 40023, 40030, 130144, 40035, 40036, 40044, 81007, 31858, 130171, 162950, 40071, 162952, 162953, 162954, 162956, 162957, 81039, 162959, 162961, 40084, 162967, 162970, 162973, 81056, 40098, 162981, 162983, 40109, 40110, 162995, 162997, 81080, 81089, 163010, 163009, 163012, 163014, 163015, 163019, 163020, 163023, 40144, 40145, 40149, 163029, 163031, 163034, 163038, 163040, 31982, 40175, 163055, 130294, 163065, 163066, 130299, 163067, 163070, 163071, 163073, 163076, 32010, 163085, 163088, 32018, 163092, 163093, 40214, 163094, 163096, 163097, 32026, 163102, 163103, 163104, 163105, 163106, 163107, 163108, 163109, 163111, 163112, 163113, 163114, 163115, 163118, 130354, 163122, 163124, 163126, 163133, 163136, 163138, 163141, 163142, 163146, 163147, 163148, 163149, 163150, 32078, 130392, 130402, 40294, 40319, 40323, 40330, 32140, 40332, 40336, 40337, 40342, 130457, 130460, 40354, 40355, 130466, 40361, 130481, 40370, 40373, 163255, 40375, 163257, 40381, 163261, 163262, 163265, 40388, 163270, 163271, 163278, 130519, 163288, 163287, 130524, 163292, 163295, 163296, 40416, 163298, 163299, 163300, 163304, 40424, 40426, 163307, 40428, 163309, 212467, 163318, 163320, 40440, 163324, 163325, 163329, 163330, 163332, 163335, 40456, 163340, 163345, 163352, 163357, 163359, 130595, 163364, 163366, 163371, 163375, 163376, 163377, 130610, 163378, 40501, 163382, 163387, 130621, 163396, 163400, 40521, 163405, 163420, 130662, 130665, 40556, 163440, 163444, 163445, 40566, 40567, 163450, 163458, 163465, 110645, 163469, 163470, 163471, 110646, 163479, 40601, 163483, 40605, 163496, 163501, 163503, 212656, 163504, 163510, 130742, 163514, 163515, 40637, 163518, 163519, 163521, 163526, 163533, 163535, 40657, 163538, 163542, 130782, 40672, 163553, 40674, 163555, 163556, 40680, 40682, 163563, 163571, 40707, 163601, 163621, 163632, 40753, 40756, 163640, 163661, 40782, 180062, 40800, 163686, 163688, 163706, 163725, 163726, 163730, 163732, 90005, 90006, 90007, 212888, 163737, 90010, 212891, 90011, 212893, 90014, 90015, 212896, 90016, 163744, 90018, 212900, 212901, 212902, 163751, 212904, 212907, 90028, 90029, 212910, 90031, 212912, 163760, 163759, 163763, 212908, 212917, 212921, 163771, 212924, 90045, 163774, 40892, 212929, 163780, 212934, 163786, 163791, 212944, 90065, 212948, 212952, 212958, 212959, 212960, 212962, 180196, 212966, 212971, 212972, 212973, 212975, 212976, 90097, 40945, 212979, 212982, 90107, 212988]
#analysed_pseudo = [0, 1]

##############################################################################################
#modifying shell scripts for our needs
en = 600
line_to_replace = "dsets=(\"enrCoax\")"
new_line = "dsets=(\"EnrBEGe\" \"EnrCoax\")"
def get_new_script(script, en, it):
	f = open(script,"r")
	lines = f.readlines()
	#print(lines)
	f.close()
	new_script = "../shell_scripts/lin_fit_{}_{}.sh".format(en, it)
	f = open(new_script,"w+")
	for line in lines:
		if line.count('dsets') and line.count('#')==0:
			line = line.replace("(\"enrCoax\")", "(\"enrBEGe\" \"enrCoax\")")
			print(line)
		elif line.count("/nfs/gerda2/users/rizalinko/gamma-fitter/run0053-run0092"):
			line="odir=\"/nfs/gerda2/users/rizalinko/gamma-fitter/run0053-run0092/sensitivity_improved_fit3/\"\nif [ ! -d ${odir} ]; then\n"
			print(line)
		elif line.count("gammacounts"):
			line = line.replace("gammacounts", "peaksearch")
			print(line)
		elif line.count("en++));"):
			if en < 1000 or en == 5000:
				line = 'for ((en={}; en<{}; en++));'.format(en, en+400)
			else:
				line = 'for ((en={}; en<{}; en++));'.format(en, en+1000)
		f.write(line)
	f.close()
	
	return new_script
##############################################################################################
log_dir = "/nfs/gerda2/users/rizalinko/gamma-fitter/logs_newsens/"
idx = analysed_pseudo.index(200173)
for it in analysed_pseudo[idx+1:]:
	sleep(3000)
	print("iteration {} {}".format(it, analysed_pseudo.index(it)))
	file_name = "/nfs/gerda2/users/rizalinko/gerda-bkg-model/gerda-bkg-model/input/data/datafake-bkg-model-v1.0_{}.root".format(it)
        	
	if os.path.isfile(file_name) == False:
		continue
	le = np.arange(200, 1000, 400)
	he = np.arange(1000, 6000, 1000)
	energies = np.append(le, he)
	for en in energies:
		script = '../shell_scripts/run_sens_study_iter_based_000.sh'

		script = get_new_script(script, en, it)	
		
		log_time =  str(time.time())
		command = "qsub -q gerda -V -d {} -e localhost:erlog_{}.txt   -o localhost:log_{}_{}.txt -N {}_{} ".format\
			(log_dir, log_time, log_time, en, 'lfit', it)
		inp_args = " -v inp_bin='{}',inp_bat='{}',inp_log='{}',inp_iter='{}',inp_pseudo_path='{}',inp_woi='{}' {}".format\
			(str(ibinning), bat_precision, log_time, it, pseudo_path, woi, script)



		launch_command =  "".join([command, inp_args])
		print launch_command
		os.system(launch_command)
		submitted_j +=1
	if submitted_j>50:
		sleep(1000)




'''
 inp_ds='EnrBEGe'
 inp_bin='1'
 inp_bat='1'
 inp_bat='low'
 inp_log='0'
 inp_woi='114'
-bash-4.2$
'''




